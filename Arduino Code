#include <AccelStepper.h>
#include <Servo.h>

// --- Stepper Motor Pins ---
#define X_STEP_PIN 2
#define X_DIR_PIN 5
#define Y_STEP_PIN 3
#define Y_DIR_PIN 6

// --- Pen Servo Pin ---
#define PEN_PIN 9

#define PEN_UP 90
#define PEN_DOWN 0

AccelStepper stepperX(AccelStepper::DRIVER, X_STEP_PIN, X_DIR_PIN);
AccelStepper stepperY(AccelStepper::DRIVER, Y_STEP_PIN, Y_DIR_PIN);
Servo pen;

void setup() {
  Serial.begin(115200);
  stepperX.setMaxSpeed(1000); stepperX.setAcceleration(500);
  stepperY.setMaxSpeed(1000); stepperY.setAcceleration(500);
  pen.attach(PEN_PIN);
  penUp();
  Serial.println("XY Plotter Ready");
}

void loop() {
  if (Serial.available()) {
    String command = Serial.readStringUntil('\n');
    command.trim();
    if (command.length() == 0) return;

    int firstComma = command.indexOf(',');
    int lastComma = command.lastIndexOf(',');
    if (firstComma == -1 || lastComma == -1 || firstComma == lastComma) return;

    long x = command.substring(0, firstComma).toInt();
    long y = command.substring(firstComma + 1, lastComma).toInt();
    String penState = command.substring(lastComma + 1);

    moveTo(x, y);
    if (penState == "DOWN") penDown();
    else penUp();
  }
}

void moveTo(long x, long y) {
  stepperX.moveTo(x); stepperY.moveTo(y);
  while (stepperX.distanceToGo() != 0 || stepperY.distanceToGo() != 0) {
    stepperX.run(); stepperY.run();
  }
}

void penUp() { pen.write(PEN_UP); delay(300); }
void penDown() { pen.write(PEN_DOWN); delay(300); }
